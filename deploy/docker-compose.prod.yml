# Production override for docker-compose.yaml
# This file adds production-specific configurations following industry best practices
# Usage: docker compose -f docker-compose.yaml -f docker-compose.prod.yml -f docker-compose.stg_prod.yml up
# Note: Network configuration is handled by docker-compose.stg_prod.yml or docker-compose.e2e.yml

services:
  frontend:
    # Production: no volume mounts, use built image
    restart: always
    stop_grace_period: 30s
    environment:
      - RUST_ENV=production
      - RUST_LOG=info
      - DOCKER_ENV=true
    networks:
      - stg_rd_net
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    # Production: use default nginx command from Dockerfile

  backend:
    # Production: no volume mounts, use built binary
    restart: always
    stop_grace_period: 30s
    environment:
      - RUST_ENV=production
      - RUST_LOG=info
      - RUST_BACKTRACE=0
    networks:
      - stg_rd_net
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    # Production: use default binary command from Dockerfile

  redis:
    restart: always
    stop_grace_period: 10s
    # Production: ensure persistence and security
    # Only set requirepass if REDIS_PASSWORD is provided
    command: >
      sh -c "
      if [ -n \"$${REDIS_PASSWORD}\" ]; then
        redis-server --appendonly yes --requirepass \"$${REDIS_PASSWORD}\"
      else
        redis-server --appendonly yes
      fi
      "
    networks:
      - stg_rd_net
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

  arangodb:
    restart: always
    stop_grace_period: 30s
    # Production: ensure data persistence
    volumes:
      - ${VOLUME_PATH}/arango_data:/var/lib/arangodb3:rw
      - ${VOLUME_PATH}/arango_apps_data:/var/lib/arangodb3-apps:rw
    networks:
      - stg_rd_net
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
        window: 120s

